Архитектура решения
===================

Архитектура услуги **V2TextMail** построена на базе существующей системы **VoiceBox** и представляет собой модульное решение, включающее компоненты обработки сигнализации и 
медиатрафика, модули распознавания речи и взаимодействия с внешними сервисами оператора.

Размещение
----------
Компоненты услуги **V2TextMail** развернуты в ЦОД оператора ООО «Ромашка Телеком» в г. Москве на базе виртуальной инфраструктуры системы **VoiceBox**
без развертывания дополнительного аппаратного оборудования. Для обеспечения передачи данных в почтовый сервис оператора организовано новое сетевое взаимодействие с 
почтовым сервером оператора.

Новые программные модули :term:`voice2text` и :term:`email_gw` размещены на виртуальных машинах совместно с существующими компонентами обработки сигнализации и медиатрафика и 
запущены в двух экземплярах для обеспечения отказоустойчивости.

Состав системы
--------------
Состав модулей **VoiceBox** участвующих в предоставлении услуги **V2TextMail** представлен в :ref:`Таблице 1 <voicebox_modules>`.

.. list-table:: Таблица 1. Модули VoiceBox, участвующие в предоставлении услуги V2TextMail
   :name: voicebox_modules
   :header-rows: 1
   :widths: 5 20 35 40

   * - № п/п
     - Модуль
     - Назначение
     - Основные взаимодействия
   * - 1
     - sip_processing
     - Обработка SIP-сигнализации, управление логикой
       переадресации вызовов на сервис VoiceBox
       
       и определение статуса подключения услуги для абонента
     - VoiceDB, rtp_processing, voice2text
   * - 2
     - rtp_processing
     - Прием и передача медиатрафика (голосовых данных) при переадресованных вызовах
     - sip_processing, voice2text
   * - 3
     - VoiceDB
     - База данных системы VoiceBox, содержащая информацию о профилях абонентов
     - sip_processing, email_gw
   * - 4
     - voice2text
     - Модуль распознавания речи и преобразования голосовых сообщений в текстовый формат
     - rtp_processing, email_gw
   * - 5
     - email_gw
     - Модуль передачи данных в почтовую систему оператора посредством интеграционного
       интерфейса EmailAPI
     - voice2text, VoiceDB, почтовая система оператора
   * - 6
     - Grafana
     - Система мониторинга, используемая для визуализации метрик и показателей работы услуги
     - Компоненты системы VoiceBox

Описание взаимодействия компонентов
-----------------------------------
Взаимодействие компонентов услуги **V2TextMail** осуществляется в рамках существующей архитектуры системы **VoiceBox** с использованием дополнительных программных модулей
для обработки голосовых сообщений и передачи данных в почтовую систему оператора и выглядит следующим образом:

1. При поступлении вызова с переадресацией на сервис **VoiceBox** модуль :term:`sip_processing` выполняет проверку статуса подключения услуги для вызываемого абонента в базе данных :term:`VoiceDB`.
2. При активной услуге медиатрафик передается через модуль :term:`rtp_processing` в модуль **voice2text** для выполнения распознавания речи и формирования текстовой версии голосового сообщения.
3. Полученные результаты транскрибации, а также данные о вызывающем и вызываемом абонентах передаются в модуль **email_gw**. Модуль **email_gw** запрашивает адрес электронной почты абонента в базе данных **VoiceDB** и направляет подготовленные данные в почтовую систему оператора, посредством интеграционного интерфейса :term:`EmailAPI`. 
4. Почтовая система оператора формирует и отправляет электронное письмо абоненту и передает в систему **VoiceBox** статус получения данных для последующей обработки.

Схема взаимодействия компонентов услуги представлена на :ref:`Рисунке 1 <v2textmail_sequence>`.

.. _v2textmail_sequence:

.. uml::
   :caption: Рисунок 1. Схема взаимодействия компонентов услуги V2TextMail
   :align: center

   @startuml

   autonumber
   hide footbox

   actor "Абонент A\n(вызывающий)" as A
   actor "Абонент B\n(вызываемый)" as B

   participant "Сеть оператора\n(переадресация на VoiceBox)" as NET
   participant "sip_processing" as SIP
   database   "VoiceDB" as DB
   participant "rtp_processing" as RTP
   participant "voice2text" as V2T
   participant "email_gw" as EGW
   participant "Почтовая система оператора\n(сторона оператора)" as MAIL

   A -> NET : Вызов A→B
   NET -> SIP : SIP-сигнализация\n(вызов/переадресация на VoiceBox)

   SIP -> DB : Запрос статуса услуги/проверка абонента
   DB --> SIP : Результат проверки

   alt Услуга активна
     SIP -> RTP : Инициация медиасессии
     RTP -> V2T : Передача медиатрафика (RTP)
     V2T -> V2T : Распознавание речи\n(формирование текста)
     V2T -> EGW : Текст транскрибации\n+ метаданные вызова

     EGW -> DB : Запрос e-mail профиля абонента B
     DB --> EGW : e-mail адрес

     EGW -> MAIL : Передача данных для формирования письма\n(по интерфейсу EmailAPI)
     MAIL --> EGW : Подтверждение получения данных\n(статус по EmailAPI)
     MAIL -> B : Отправка e-mail уведомления
   else Услуга не активна
     SIP -> RTP : Обработка вызова по базовой логике VoiceBox
   end

   note over EGW,MAIL
   EmailAPI — интеграционный интерфейс взаимодействия
   между email_gw и почтовой системой оператора.
   end note

   @enduml


   




