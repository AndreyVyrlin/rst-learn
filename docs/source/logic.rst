Логика работы услуги в штатном режиме
=====================================

Общая последовательность работы услуги
--------------------------------------
В штатном режиме услуга **V2TextMail** функционирует в составе системы **VoiceBox** и обеспечивает автоматическую обработку голосовых сообщений, оставленных
при переадресации вызовов, с последующей транскрибацией и передачей текстовой версии сообщения на электронную почту абонента.

Услуга активируется в случаях, когда вызов абоненту не был принят и был переадресован на сервис **VoiceBox** в соответствии с настройками сети оператора.

Обработка входящего вызова
--------------------------
При поступлении входящего вызова от абонента **А** к абоненту **Б** вызов обрабатывается сетевыми элементами оператора. В случае срабатывания переадресации вызов передается в 
систему **VoiceBox**. 

Модуль **sip_processing** выполняет проверку статуса подключения услуги **V2TextMail** для вызываемого абонента на основании данных, содержащихся в базе данных **VoiceDB**.

Если услуга для абонента активна, вызов обрабатывается с использованием логики услуги **V2TextMail**. В противном случае применяется базовая логика обработки вызовов системы **VoiceBox**.

Запись и анализ голосового сообщения
------------------------------------
В случае активной услуги медиатрафик вызова передается в модуль **rtp_processing** для записи голосового сообщения.

После начала записи сообщение предается в модуль **voice2text**, в котором выполняется распознавание речи и формирование текстовой версии голосового сообщения.

Если вызывающий абонент не оставил голосового сообщения и завершил вызов без передачи речевой информации, дальнейшая обработка вызова в рамках услуги **V2TextMail** не выполняется.

Формирование и передача данных для отправки
-------------------------------------------
По завершении распознавания речи модуль **voice2text** передает в модуль **email_gw** текстовую версию голосового сообщения, а также метаданные вызова, включая номер вызывающего 
абонента и время поступления вызова.

Модуль **email_gw** запрашивает в базе данных **VoiceDB** адрес электронной почты вызываемого абонента и формирует набор данных, необходимых для передачи в почтовую систему оператора.

Передача данных осуществляется посредством интеграционного интерфейса **EmailAPI**. Почтовая система оператора подтверждает получение данных и выполняет формирование и отправку 
электронного письма абоненту.

Обработка ошибок передачи данных
--------------------------------
В случае отсутствия подтверждения получения данных от почтовой системы оператора модуль **email_gw** выполняет повторные попытки передачи данных в соответствии с установленными 
параметрами конфигурации.

При превышении допустимого количества попыток передачи дальнейшая обработка сообщения прекращается, а информация о неуспешной передаче фиксируется в журналах системы.

Завершение обработки вызова
---------------------------
После успешной передачи данных в почтовую систему оператора или завершения попыток передачи при возникновении ошибок обработка вызова в рамках услуги **V2TextMail** считается завершенной.

Дальнейшие действия по доставке электронного письма абоненту выполняются почтовой системой оператора и находятся вне зоны ответственности системы **VoiceBox**.

